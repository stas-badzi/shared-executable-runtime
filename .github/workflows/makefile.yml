name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux-x64:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Compile runtime
      run: make

    - name: Compile tests
      run: |
        echo -e '#include <stdio.h>\nint main() {fprintf(stderr,"Executable works\\n");}\nvoid print() {fprintf(stderr,"Library works\\n");}' > dll.c
        echo -e 'extern void print();\nint main() {print();}' > main.c
        gcc -shared -fPIC crt.o dll.c -o libdll.so
        gcc main.c -L. -ldll

    - name: Test Executable
      run: ./libdll.so

    - name: Test Shared Object
      run: LD_LIBRARY_PATH=. ./a.out
      
  build-linux-arm64:

    runs-on: ubuntu-latest-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Compile runtime
      run: make

    - name: Compile tests
      run: |
        echo -e '#include <stdio.h>\nint main() {fprintf(stderr,"Executable works\\n");}\nvoid print() {fprintf(stderr,"Library works\\n");}' > dll.c
        echo -e 'extern void print();\nint main() {print();}' > main.c
        gcc -shared -fPIC crt.o dll.c -o libdll.so
        gcc main.c -L. -ldll

    - name: Test Executable
      run: ./libdll.so

    - name: Test Shared Object
      run: LD_LIBRARY_PATH=. ./a.out
      
  build-linux-x86:

    runs-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v4

    - name: Compile runtime
      run: make C_FLAGS=-m32

    - name: Compile tests
      run: |
        echo -e '#include <stdio.h>\nint main() {fprintf(stderr,"Executable works\\n");}\nvoid print() {fprintf(stderr,"Library works\\n");}' > dll.c
        echo -e 'extern void print();\nint main() {print();}' > main.c
        gcc -m32 -shared -fPIC crt.o dll.c -o libdll.so
        gcc -m32 main.c -L. -ldll

    - name: Test Executable
      run: ./libdll.so

    - name: Test Shared Object
      run: LD_LIBRARY_PATH=. ./a.out
      
  build-linux-arm32:

    runs-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v4

    - name: Compile runtime
      run: make C_FLAGS=-m32

    - name: Compile tests
      run: |
        echo -e '#include <stdio.h>\nint main() {fprintf(stderr,"Executable works\\n");}\nvoid print() {fprintf(stderr,"Library works\\n");}' > dll.c
        echo -e 'extern void print();\nint main() {print();}' > main.c
        gcc -m32 -shared -fPIC crt.o dll.c -o libdll.so
        gcc -m32 main.c -L. -ldll

    - name: Test Executable
      run: ./libdll.so

    - name: Test Shared Object
      run: LD_LIBRARY_PATH=. ./a.out
